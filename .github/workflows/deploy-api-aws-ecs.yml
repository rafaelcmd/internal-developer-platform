name: API - Deploy to AWS ECS

on:
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

jobs:
  build-api-application:
    runs-on: ubuntu-latest

    steps:
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ env.AWS_ROLE_ARN }}
          role-session-name: github-actions-${{ github.run_id }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Log in to AWS ECR
        run: aws ecr get-login-password --region ${{ env.AWS_REGION }} | docker login --username AWS --password-stdin ${{ env.AWS_ACCOUNT_ID }}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com

      - name: Build and Push Docker image
        run: |
          docker build -f api/Dockerfile.dev -t internal-developer-platform-api api
          docker tag internal-developer-platform-api:latest ${{ env.AWS_ACCOUNT_ID }}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com/internal-developer-platform-repo:latest
          docker push ${{ env.AWS_ACCOUNT_ID }}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com/internal-developer-platform-repo:latest

  deploy-api-application-to-ecs:
    needs: build-api-application
    runs-on: ubuntu-latest

    steps:
      - name: Update ECS Service
        run: |
          # Get the current task definition
          aws ecs describe-task-definition --task-definition resource-provisioner-api-task --query "taskDefinition" --output json > task-definition.json
          
          # Update the image URI and keep only allowed fields for register-task-definition
          IMAGE_URI="${{ env.AWS_ACCOUNT_ID }}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com/internal-developer-platform-repo:latest"
          jq --arg image "$IMAGE_URI" '
            .containerDefinitions[0].image = $image |
            {
              family: .family,
              taskRoleArn: .taskRoleArn,
              executionRoleArn: .executionRoleArn,
              networkMode: .networkMode,
              containerDefinitions: .containerDefinitions,
              volumes: .volumes,
              placementConstraints: .placementConstraints,
              requiresCompatibilities: .requiresCompatibilities,
              cpu: .cpu,
              memory: .memory,
              pidMode: .pidMode,
              ipcMode: .ipcMode,
              proxyConfiguration: .proxyConfiguration,
              inferenceAccelerators: .inferenceAccelerators,
              ephemeralStorage: .ephemeralStorage,
              runtimePlatform: .runtimePlatform
            } | with_entries(select(.value != null))
          ' task-definition.json > updated-task-definition.json
          
          # Register the new task definition
          NEW_TASK_DEFINITION_ARN=$(aws ecs register-task-definition --cli-input-json file://updated-task-definition.json --query "taskDefinition.taskDefinitionArn" --output text)
          
          echo "New task definition ARN: $NEW_TASK_DEFINITION_ARN"

          aws ecs update-service \
            --cluster internal-developer-platform-cluster \
            --service resource-provisioner-api-service \
            --task-definition $NEW_TASK_DEFINITION_ARN \
            --force-new-deployment \
            --region ${{ env.AWS_REGION }}
            
          aws ecs wait services-stable \
            --cluster internal-developer-platform-cluster \
            --services resource-provisioner-api-service \
            --region ${{ env.AWS_REGION }}